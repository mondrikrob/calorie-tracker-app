<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3182ce;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #3182ce;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2c5282;
        }

        button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }

        .status.success {
            background-color: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background-color: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .recent-meals {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .recent-meals h3 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .meal-item {
            background-color: #f7fafc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #3182ce;
        }

        .meal-item .meal-header {
            font-weight: 500;
            color: #2d3748;
        }

        .meal-item .meal-description {
            color: #4a5568;
            font-size: 14px;
            margin-top: 5px;
        }

        .meal-item .meal-meta {
            color: #718096;
            font-size: 12px;
            margin-top: 5px;
        }

        .config-section {
            background-color: #fff5f5;
            border: 2px solid #feb2b2;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #742a2a;
            margin-bottom: 10px;
        }

        .config-section p {
            color: #742a2a;
            font-size: 14px;
        }

        .config-inputs {
            display: none;
        }

        .config-inputs.show {
            display: block;
            margin-top: 15px;
        }

        .config-inputs input {
            margin-bottom: 10px;
        }

        .config-btn {
            background-color: #e53e3e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .config-btn:hover {
            background-color: #c53030;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçΩÔ∏è Meal Logger</h1>
        
        <!-- Configuration Section -->
        <div class="config-section" id="config-section">
            <h3>‚öôÔ∏è Setup Required</h3>
            <p>Please configure your Supabase credentials to start logging meals.</p>
            <button class="config-btn" onclick="toggleConfig()">Configure Supabase</button>
            
            <div class="config-inputs" id="config-inputs">
                <input type="text" id="supabase-url" placeholder="Supabase URL (https://your-project.supabase.co)">
                <input type="text" id="supabase-key" placeholder="Supabase Anon Key (eyJhbGciOiJIUzI1NiIs...)">
                <button class="config-btn" onclick="saveConfig()">Save Configuration</button>
            </div>
        </div>
        
        <!-- Main Form -->
        <form id="meal-form" style="display: none;">
            <div class="form-group">
                <label for="meal-type">Meal Type:</label>
                <select id="meal-type" required>
                    <option value="">Select meal type</option>
                    <option value="breakfast">üåÖ Breakfast</option>
                    <option value="lunch">üåû Lunch</option>
                    <option value="dinner">üåô Dinner</option>
                    <option value="snack">üçé Snack</option>
                </select>
            </div>

            <div class="form-group">
                <label for="meal-date">Date:</label>
                <input type="date" id="meal-date" required>
            </div>

            <div class="form-group">
                <label for="meal-time">Time:</label>
                <input type="time" id="meal-time" required>
            </div>

            <div class="form-group">
                <label for="photo">Photo (optional):</label>
                <input type="file" id="photo" accept="image/*">
                <canvas id="canvas" style="display: none;"></canvas>
            </div>

            <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" placeholder="Describe what you ate (e.g., grilled chicken breast with rice and vegetables)" required></textarea>
            </div>

            <button type="submit" id="submit-btn">Log Meal</button>
        </form>

        <div id="status" class="status"></div>
        
        <div class="recent-meals" id="recent-meals" style="display: none;">
            <h3>Recent Meals</h3>
            <div id="recent-list"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Global variables
        let supabase = null;
        
        // DOM elements
        const form = document.getElementById('meal-form');
        const photoInput = document.getElementById('photo');
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        const submitBtn = document.getElementById('submit-btn');
        const recentList = document.getElementById('recent-list');
        const recentMealsDiv = document.getElementById('recent-meals');
        const configSection = document.getElementById('config-section');
        const configInputs = document.getElementById('config-inputs');

        // Configuration management
        function toggleConfig() {
            configInputs.classList.toggle('show');
        }

        function saveConfig() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                showStatus('Please fill in both URL and API key', true);
                return;
            }
            
            if (!url.includes('supabase.co')) {
                showStatus('Please enter a valid Supabase URL', true);
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            
            // Initialize Supabase
            try {
                supabase = window.supabase.createClient(url, key);
                
                // Hide config section and show form
                configSection.style.display = 'none';
                form.style.display = 'block';
                recentMealsDiv.style.display = 'block';
                
                showStatus('Configuration saved successfully! üéâ');
                
                // Set current date and time
                setCurrentDateTime();
                
                // Load recent meals
                loadRecentMeals();
                
            } catch (error) {
                showStatus('Error initializing Supabase: ' + error.message, true);
            }
        }

        function loadConfig() {
            const url = localStorage.getItem('supabase_url');
            const key = localStorage.getItem('supabase_key');
            
            if (url && key) {
                try {
                    supabase = window.supabase.createClient(url, key);
                    configSection.style.display = 'none';
                    form.style.display = 'block';
                    recentMealsDiv.style.display = 'block';
                    setCurrentDateTime();
                    loadRecentMeals();
                } catch (error) {
                    showStatus('Error loading configuration: ' + error.message, true);
                }
            }
        }

        // Set current date and time as defaults
        function setCurrentDateTime() {
            const now = new Date();
            document.getElementById('meal-date').valueAsDate = now;
            document.getElementById('meal-time').value = now.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Compress image function
        function compressImage(file, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Calculate new dimensions
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;
                    
                    // Set canvas size
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Upload photo to Supabase Storage
        async function uploadPhoto(file) {
            try {
                const compressedFile = await compressImage(file);
                const fileName = `meal_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                
                const { data, error } = await supabase.storage
                    .from('meal-photos')
                    .upload(fileName, compressedFile);
                
                if (error) throw error;
                
                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('meal-photos')
                    .getPublicUrl(fileName);
                
                return urlData.publicUrl;
            } catch (error) {
                console.error('Photo upload error:', error);
                throw error;
            }
        }

        // Show status message
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${isError ? 'error' : 'success'}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Load recent meals
        async function loadRecentMeals() {
            if (!supabase) return;
            
            try {
                const { data, error } = await supabase
                    .from('meal_entries')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                recentList.innerHTML = '';
                
                if (data.length === 0) {
                    recentList.innerHTML = '<p style="color: #718096; font-style: italic;">No meals logged yet. Add your first meal above!</p>';
                    return;
                }
                
                data.forEach(meal => {
                    const mealDiv = document.createElement('div');
                    mealDiv.className = 'meal-item';
                    
                    const date = new Date(meal.created_at).toLocaleDateString();
                    const time = meal.meal_time;
                    const status = meal.processed ? 
                        (meal.calories ? `${meal.calories} cal` : 'Processed') : 
                        'Pending analysis';
                    
                    mealDiv.innerHTML = `
                        <div class="meal-header">${meal.meal_type.charAt(0).toUpperCase() + meal.meal_type.slice(1)} - ${status}</div>
                        <div class="meal-description">${meal.description}</div>
                        <div class="meal-meta">${date} at ${time}</div>
                    `;
                    
                    recentList.appendChild(mealDiv);
                });
            } catch (error) {
                console.error('Error loading recent meals:', error);
                showStatus('Error loading recent meals: ' + error.message, true);
            }
        }

        // Form submission
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!supabase) {
                    showStatus('Please configure Supabase first', true);
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging...';
                
                try {
                    let photoUrl = null;
                    
                    // Upload photo if provided
                    if (photoInput.files[0]) {
                        showStatus('Uploading photo...');
                        photoUrl = await uploadPhoto(photoInput.files[0]);
                    }
                    
                    // Insert meal entry
                    const { data, error } = await supabase
                        .from('meal_entries')
                        .insert([{
                            meal_type: document.getElementById('meal-type').value,
                            meal_date: document.getElementById('meal-date').value,
                            meal_time: document.getElementById('meal-time').value,
                            description: document.getElementById('description').value,
                            photo_url: photoUrl
                        }]);
                    
                    if (error) throw error;
                    
                    showStatus('Meal logged successfully! üéâ');
                    form.reset();
                    
                    // Reset date and time to current
                    setCurrentDateTime();
                    
                    // Reload recent meals
                    await loadRecentMeals();
                    
                } catch (error) {
                    console.error('Error logging meal:', error);
                    showStatus('Error logging meal: ' + error.message, true);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Log Meal';
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });
    </script>
</body>
</html>